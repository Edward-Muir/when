# Daily Leaderboard Feature

Global leaderboard for daily challenges allowing players to compare scores with others who completed the same daily puzzle.

## Overview

- **No login required** - Random fun names generated by default (e.g., "Brave Penguin")
- **Device fingerprinting** - Uses browser signals + random UUID to identify devices
- **Server-side validation** - Prevents basic cheating by validating scores against game rules
- **Vercel KV storage** - Redis-compatible sorted sets with automatic TTL cleanup

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /api/leaderboard/submit     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     React App       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ Vercel Serverless  â”‚
â”‚                     â”‚                                       â”‚    Functions       â”‚
â”‚ - GamePopup.tsx     â”‚     GET /api/leaderboard/[date]      â”‚                    â”‚
â”‚ - TopBar.tsx        â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ - submit.ts        â”‚
â”‚ - Leaderboard.tsx   â”‚                                       â”‚ - [date].ts        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                       â”‚
                                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                              â”‚    Vercel KV       â”‚
                                                              â”‚  (Redis-compat)    â”‚
                                                              â”‚                    â”‚
                                                              â”‚ leaderboard:{date} â”‚
                                                              â”‚ submission:{date}: â”‚
                                                              â”‚   {deviceId}       â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Files Created

### `api/leaderboard/submit.ts`

POST endpoint for submitting daily results.

**Request body:**

```typescript
{
  date: string; // YYYY-MM-DD, must match today
  displayName: string; // Optional, max 20 chars
  correctCount: number; // Number of correct placements
  totalAttempts: number; // correctCount + mistakes
  emojiGrid: string; // "ðŸŸ©ðŸŸ¥ðŸŸ©ðŸŸ©..." pattern
  deviceId: string; // From deviceFingerprint.ts
  theme: string; // Must match server-computed theme
}
```

**Validation logic:**

1. Date must match today (UTC): `new Date().toISOString().split('T')[0]`
2. `correctCount >= 0` (no upper limit - sudden death can go indefinitely)
3. Emoji grid: count ðŸŸ© must equal `correctCount`, count ðŸŸ¥ must be 1-5
4. `totalAttempts` must equal `correctCount + mistakeCount`
5. Theme must match `getThemeDisplayName(getDailyTheme(date))`
6. Check `submission:{date}:{deviceId}` key - reject if exists

**Scoring formula:**

```typescript
const score = correctCount * 100 - mistakeCount;
```

Higher `correctCount` wins. Tiebreaker: fewer mistakes.

**Storage:**

```typescript
// Store in sorted set
await kv.zadd(`leaderboard:${date}`, { score, member: JSON.stringify(entry) });

// Mark device as submitted (25hr TTL for timezone edge cases)
await kv.set(`submission:${date}:${deviceId}`, '1', { ex: 25 * 60 * 60 });

// Set leaderboard TTL (7 days)
await kv.expire(`leaderboard:${date}`, 7 * 24 * 60 * 60);
```

**Response:**

```typescript
{ success: true, rank: number, totalPlayers: number }
// or
{ error: "Already submitted today" | "Invalid date" | ... }
```

---

### `api/leaderboard/[date].ts`

GET endpoint for fetching leaderboard.

**Query params:**

- `date` (path param): YYYY-MM-DD
- `deviceId` (optional): If provided, returns player's rank
- `limit` (optional): Max entries to return (default 50, max 100)

**Response:**

```typescript
{
  date: string;
  leaderboard: Array<{
    displayName: string;
    correctCount: number;
    totalAttempts: number;
    emojiGrid: string;
    rank: number;
  }>;
  totalPlayers: number;
  playerRank: number | null; // If deviceId provided
  playerEntry: LeaderboardEntry | null;
}
```

**Fetching logic:**

```typescript
// Get top entries (highest score first)
const entries = await kv.zrange(leaderboardKey, 0, limit - 1, { rev: true });

// Get total count
const totalPlayers = await kv.zcard(leaderboardKey);

// Find player's rank if deviceId provided
if (deviceId) {
  const allEntries = await kv.zrange(leaderboardKey, 0, -1, { rev: true });
  // Search for matching deviceId in parsed entries
}
```

---

### `src/utils/deviceFingerprint.ts`

Generates a stable device ID for identifying repeat submissions.

**Components hashed:**

```typescript
const components: string[] = [];
components.push(`${window.screen.width}x${window.screen.height}`);
components.push(`${window.screen.colorDepth}`);
components.push(`${window.devicePixelRatio}`);
components.push(Intl.DateTimeFormat().resolvedOptions().timeZone);
components.push(navigator.language);
components.push(navigator.platform);
components.push(`${navigator.hardwareConcurrency || 0}`);
components.push(`${navigator.maxTouchPoints || 0}`);
components.push(crypto.randomUUID().slice(0, 8)); // Random for uniqueness
```

**Hashing:**

```typescript
const data = components.join('|');
const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(data));
// Convert to hex, return first 32 chars
```

**Storage:**

- Key: `when-device-id` in localStorage
- Generated once, reused thereafter
- If user clears localStorage, new ID generated (acceptable - no prizes)

---

### `src/hooks/useLeaderboard.ts`

React hook for leaderboard operations.

**State:**

```typescript
interface LeaderboardState {
  isSubmitting: boolean;
  hasSubmitted: boolean;
  submitError: string | null;
  rank: number | null;
  totalPlayers: number | null;
  isLoading: boolean;
  loadError: string | null;
  data: LeaderboardData | null;
}
```

**Exports:**

```typescript
{
  // Submission state
  isSubmitting, hasSubmitted, submitError, rank, totalPlayers,

  // Fetch state
  isLoading, loadError, leaderboard, playerEntry,

  // Actions
  submitResult: (result: DailyResult, displayName: string) => Promise<boolean>,
  fetchLeaderboard: (date: string) => Promise<LeaderboardData | null>,
  resetState: () => void,
}
```

**submitResult flow:**

1. Get device fingerprint
2. POST to `/api/leaderboard/submit`
3. Update state with rank/totalPlayers on success
4. Return true/false for caller to handle

**fetchLeaderboard flow:**

1. Get device fingerprint
2. GET `/api/leaderboard/${date}?deviceId=${deviceId}`
3. Update state with leaderboard data
4. Also sets `hasSubmitted` if player found in results

---

### `src/components/Leaderboard.tsx`

Full-screen modal showing complete leaderboard.

**Props:**

```typescript
interface LeaderboardProps {
  isOpen: boolean;
  onClose: () => void;
  entries: LeaderboardEntry[];
  totalPlayers: number;
  playerRank: number | null;
  isLoading?: boolean;
  error?: string | null;
}
```

**UI structure:**

- Header: Trophy icon + "Daily Leaderboard" + close button
- Subheader: Player count + your rank (if submitted)
- Body: Scrollable list of entries
  - Rank 1-3: Medal emojis (ðŸ¥‡ðŸ¥ˆðŸ¥‰)
  - Rank 4+: `#N` in muted text
  - Player's row highlighted with `bg-accent/10`
  - Each row: rank | name | correctCount (no emoji grid for cleaner display)

---

### `src/components/LeaderboardSubmit.tsx`

Inline component for game over popup (daily mode only).

**Props:**

```typescript
interface LeaderboardSubmitProps {
  dailyResult: DailyResult;
}
```

**UI states:**

1. **Not submitted yet:**
   - Leaderboard preview (top 3 with medals)
   - Name input (pre-filled with random name like "Brave Penguin" if no saved name)
   - "Submit to Leaderboard" button
   - Error message if submission fails

2. **Already submitted:**
   - Leaderboard preview showing top 3 + player's entry (if outside top 3)
   - Player's entry highlighted with `bg-accent/10`
   - Total player count

**Random name generation:**

```typescript
import { uniqueNamesGenerator, adjectives, animals } from 'unique-names-generator';

function generateRandomName(): string {
  return uniqueNamesGenerator({
    dictionaries: [adjectives, animals],
    separator: ' ',
    style: 'capital',
    length: 2,
  });
}
// Generates names like "Brave Penguin", "Swift Tiger", "Clever Fox"
```

**On submit:**

```typescript
saveDisplayName(name); // Remember for next time
const success = await submitResult(dailyResult, name || 'Anonymous');
if (success) {
  markLeaderboardSubmitted(); // Prevent re-showing submit UI
  fetchLeaderboard(dailyResult.date); // Refresh to show updated list
}
```

---

## Files Modified

### `package.json`

Added dependencies:

```json
"@vercel/kv": "^3.0.0",
"unique-names-generator": "^4.7.1"
```

---

### `src/utils/playerStorage.ts`

Added three new storage functions:

```typescript
// --- Display Name Storage ---
const DISPLAY_NAME_KEY = 'when-display-name';

export function getDisplayName(): string {
  return localStorage.getItem(DISPLAY_NAME_KEY) || '';
}

export function saveDisplayName(name: string): void {
  localStorage.setItem(DISPLAY_NAME_KEY, name);
}

// --- Leaderboard Submission Tracking ---
const LEADERBOARD_SUBMITTED_KEY = 'when-leaderboard-submitted';

export function hasSubmittedToLeaderboard(): boolean {
  const stored = localStorage.getItem(LEADERBOARD_SUBMITTED_KEY);
  return stored === getTodayDateString(); // Only true if submitted TODAY
}

export function markLeaderboardSubmitted(): void {
  localStorage.setItem(LEADERBOARD_SUBMITTED_KEY, getTodayDateString());
}
```

---

### `src/components/TopBar.tsx`

**Imports added:**

```typescript
import { Trophy } from 'lucide-react';
import { useLeaderboard } from '../hooks/useLeaderboard';
import Leaderboard from './Leaderboard';
```

**State added:**

```typescript
const [isLeaderboardOpen, setIsLeaderboardOpen] = useState(false);
const { isLoading, loadError, leaderboard, totalPlayers, rank, fetchLeaderboard } =
  useLeaderboard();
```

**Effect added:**

```typescript
useEffect(() => {
  if (isLeaderboardOpen) {
    const today = new Date().toISOString().split('T')[0];
    fetchLeaderboard(today);
  }
}, [isLeaderboardOpen, fetchLeaderboard]);
```

**Button added (after theme toggle):**

```tsx
<button
  onClick={() => setIsLeaderboardOpen(true)}
  className={buttonClass}
  aria-label="View daily leaderboard"
>
  <Trophy className={iconClass} />
</button>
```

**Modal added (at end of component):**

```tsx
<Leaderboard
  isOpen={isLeaderboardOpen}
  onClose={() => setIsLeaderboardOpen(false)}
  entries={leaderboard}
  totalPlayers={totalPlayers ?? 0}
  playerRank={rank}
  isLoading={isLoading}
  error={loadError}
/>
```

---

### `src/components/GamePopup.tsx`

**Imports added:**

```typescript
import { generateEmojiGrid } from '../utils/share';
import { getDailyTheme, getThemeDisplayName } from '../utils/dailyTheme';
import { DailyResult } from '../utils/playerStorage';
import LeaderboardSubmit from './LeaderboardSubmit';
```

**In `GameOverContent` component:**

Added variables:

```typescript
const { placementHistory, lastConfig } = gameState;
const isDaily = gameMode === 'daily';
```

Added daily result construction:

```typescript
const dailyResult: DailyResult | null =
  isDaily && lastConfig?.dailySeed
    ? {
        date: lastConfig.dailySeed,
        theme: getThemeDisplayName(getDailyTheme(lastConfig.dailySeed)),
        won: hasWinner,
        correctCount: placementHistory.filter((p) => p).length,
        totalAttempts: placementHistory.length,
        emojiGrid: generateEmojiGrid(placementHistory),
      }
    : null;
```

Added at end of component (after stats section):

```tsx
{
  dailyResult && <LeaderboardSubmit dailyResult={dailyResult} />;
}
```

**Game over popup behavior:**

- Inner modal has `onClick={isGameOver ? (e) => e.stopPropagation() : undefined}`
- This prevents clicks inside the game over popup from closing it (so users can interact with the leaderboard form)
- Other popup types (description, correct, incorrect) still close on click anywhere
- Backdrop click and Escape key still close all popup types

---

## Vercel KV Data Structure

### `leaderboard:{YYYY-MM-DD}`

Type: Sorted Set
TTL: 7 days

Members are JSON strings:

```typescript
{
  displayName: string;
  correctCount: number;
  totalAttempts: number;
  emojiGrid: string;
  deviceId: string; // Stored but not returned to clients
  timestamp: number;
}
```

Score: `correctCount * 100 - mistakeCount`

### `submission:{YYYY-MM-DD}:{deviceId}`

Type: String
Value: `"1"`
TTL: 25 hours

Used to prevent duplicate submissions.

---

## Daily Mode Game Mechanics (for validation)

Understanding the game rules is critical for server-side validation:

1. **Start**: Player has 5 cards in hand
2. **Correct placement**: Draw new card from deck (hand stays at 5)
3. **Wrong placement**: No replacement card (hand shrinks by 1)
4. **Game over**: Hand is empty (made 5 mistakes) OR deck runs out

Therefore:

- `correctCount` can be 0 to unlimited (limited only by deck size)
- `mistakeCount` is always 1-5 (game ends when hand empties)
- `totalAttempts = correctCount + mistakeCount`
- Emoji grid has exactly `totalAttempts` characters (ðŸŸ© or ðŸŸ¥)

---

## Setup Requirements

### 1. Install dependencies

```bash
cd when
npm install
```

### 2. Create Vercel KV store

1. Go to Vercel Dashboard â†’ your project â†’ Storage
2. Create new KV Database
3. Copy the connection details

### 3. Add environment variables

In Vercel Dashboard â†’ Settings â†’ Environment Variables:

```
KV_REST_API_URL=https://your-kv-url.vercel-storage.com
KV_REST_API_TOKEN=your-token-here
```

For local development, add to `.env.local`:

```
KV_REST_API_URL=https://your-kv-url.vercel-storage.com
KV_REST_API_TOKEN=your-token-here
```

### 4. Deploy

```bash
vercel deploy
```

---

## Troubleshooting

### "Already submitted today" error

- Check `localStorage.getItem('when-leaderboard-submitted')` - should be today's date
- Check Vercel KV for `submission:{date}:{deviceId}` key
- Clear localStorage to reset client-side tracking

### Leaderboard not showing entries

- Check browser console for API errors
- Verify KV environment variables are set
- Check `leaderboard:{date}` key exists in Vercel KV dashboard

### Wrong rank displayed

- Rank is 1-indexed (first place = 1)
- Calculated by `zrevrank` + 1
- Verify device ID matches between submit and fetch

### Theme validation failing

- Theme is computed from date seed: `getDailyTheme(date)`
- Must use exact same algorithm on server and client
- Check that `ALL_CATEGORIES` order matches between `api/leaderboard/submit.ts` and `src/types/index.ts`

### Device fingerprint changing

- Fingerprint includes random UUID component stored in localStorage
- If `when-device-id` is cleared, new fingerprint generated
- This is by design - allows users to "reset" but limits casual abuse
